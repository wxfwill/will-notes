# 4.事件循环

**事件循环 Event-Loop 是理解 js 单线程工作重要的一部分**

## Event Loop 流程

1. 从宏任务队列中，按照入队顺序，找到第一个执行的宏任务，放入调用栈，开始执行；
2. 执行该宏任务下所有的同步任务后，即执行栈清空后，该宏任务出队，然后微任务队列开始按照入队顺序，依次执行微任务，`直至微任务队列清空为止`；
3. 当微任务队列清空后，一个事件循环结束；
4. 执行浏览器 UI 渲染线程的渲染工作
5. 执行完本轮的宏任务后，开始第二次事件循环，回到 2，直到宏任务队列清空为止。

`注意：`

- 当我们第一次执行代码时，解析器会将整体代码`script`放入宏任务队列，因此事件循环是从第一个宏任务开始；
- 在本轮宏任务完成前遇到新的宏任务时，将新的宏任务推到宏任务队列，接着执行本轮宏任务之后代码；本轮宏任务及微任务结束后（完成了一次 event loop 后），再开始执行下一个宏任务；
- 如果在执行微任务过程中，产生新的微任务添加到微任务队列中，也需要一起清空；微任务队列没清空之前，是不会执行下一个宏任务的

## 页面渲染

> 每当一次事件循环结束后，即一个宏任务执行完成以后以及微任务队列被清空后，浏览器就会进行一次页面更新渲染。

通常我们浏览器页面刷新频率是 60fps,也就是意味着 16.67ms 要刷新一次，

:::tip
刷新频率: FPS 表示的是每秒钟画面更新次数(60fps 即：1000ms/60);

也就是说，浏览器对每一帧画面的渲染工作需要在 16ms(1000ms/60)之内完成，即每一次渲染都要在 16m 完成才不会掉帧；

举例：如果某一次渲染花了 20ms,那么它的渲染效果不会在第一帧 16ms 的时候显示，这个渲染结果会在第一帧 32ms 的时候显示，这就掉了一帧。

[参考前端性能优化--刷新率(FPS)]('https://zhuanlan.zhihu.com/p/78569750')
:::

## 参考文章

- [做一些动图，学习一下 EventLoop]('https://juejin.cn/post/6969028296893792286#heading-10')
- [要就来 45 道 Promise 面试题一次爽到底]('https://juejin.cn/post/6844904077537574919#heading-16')
